<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
  <title>Судоку</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* --- Система тем на CSS-переменных --- */
    :root, body[data-theme="purple"] { --primary-color: #a855f7; --primary-hover: #9333ea; --text-accent: #c084fc; --body-bg: #030712; --container-bg: #111827; --cell-bg: #1f2937; --grid-line: #4b5563; --given-text: #ffffff; --error-text: #f87171; --highlight-bg: var(--primary-color); --highlight-text: var(--given-text); --area-highlight-bg: rgba(168, 85, 247, 0.06); --active-cell-bg: rgba(168, 85, 247, 0.12); --hint-bg: #ffffff; --hint-text: #111827; }
    body[data-theme="orange"] { --primary-color: #f97316; --primary-hover: #ea580c; --text-accent: #fb923c; --body-bg: #0c0a09; --container-bg: #1c1917; --cell-bg: #292524; --grid-line: #57534e; --given-text: #ffffff; --error-text: #f87171; --highlight-bg: var(--primary-color); --highlight-text: var(--given-text); --area-highlight-bg: rgba(249, 115, 22, 0.06); --active-cell-bg: rgba(249, 115, 22, 0.12); --hint-bg: #ffffff; --hint-text: #1c1917; }
    body[data-theme="green"] { --primary-color: #22c55e; --primary-hover: #16a34a; --text-accent: #4ade80; --body-bg: #050f09; --container-bg: #0f1a14; --cell-bg: #1a2e24; --grid-line: #3f6251; --given-text: #ffffff; --error-text: #f87171; --highlight-bg: var(--primary-color); --highlight-text: var(--given-text); --area-highlight-bg: rgba(34, 197, 94, 0.06); --active-cell-bg: rgba(34, 197, 94, 0.12); --hint-bg: #ffffff; --hint-text: #0f1a14; }
    body[data-theme="light"] { --primary-color: #a16207; --primary-hover: #854d0e; --text-accent: #a16207; --body-bg: #f1f5f9; --container-bg: #ffffff; --cell-bg: #f8fafc; --grid-line: #e2e8f0; --given-text: #374151; --error-text: #dc2626; --highlight-bg: #fde047; --highlight-text: var(--primary-hover); --area-highlight-bg: rgba(161, 98, 7, 0.05); --active-cell-bg: rgba(161, 98, 7, 0.1); --hint-bg: var(--given-text); --hint-text: #ffffff; }
    body[data-theme="black"] { --primary-color: #6b7280; --primary-hover: #4b5563; --text-accent: #d1d5db; --body-bg: #000000; --container-bg: #111827; --cell-bg: #1f2937; --grid-line: #4b5563; --given-text: #ffffff; --error-text: #ef4444; --highlight-bg: #9ca3af; --highlight-text: #000000; --area-highlight-bg: rgba(255, 255, 255, 0.05); --active-cell-bg: rgba(255, 255, 255, 0.1); --hint-bg: #ffffff; --hint-text: #111827; }
    body[data-theme="pink"] { --primary-color: #ec4899; --primary-hover: #db2777; --text-accent: #f472b6; --body-bg: #1a0810; --container-bg: #2a0f1c; --cell-bg: #3a1628; --grid-line: #6d284f; --given-text: #ffffff; --error-text: #fca5a5; --highlight-bg: var(--primary-color); --highlight-text: var(--given-text); --area-highlight-bg: rgba(236, 72, 153, 0.06); --active-cell-bg: rgba(236, 72, 153, 0.12); --hint-bg: #ffffff; --hint-text: #2a0f1c; }
    body[data-theme="turquoise"] { --primary-color: #14b8a6; --primary-hover: #0d9488; --text-accent: #2dd4bf; --body-bg: #040f0d; --container-bg: #0a1a17; --cell-bg: #112e29; --grid-line: #1f6259; --given-text: #ffffff; --error-text: #fca5a5; --highlight-bg: var(--primary-color); --highlight-text: #040f0d; --area-highlight-bg: rgba(20, 184, 166, 0.06); --active-cell-bg: rgba(20, 184, 166, 0.12); --hint-bg: #ffffff; --hint-text: #0a1a17; }
    body[data-theme="purple"] .user-input .cell-content, body[data-theme="orange"] .user-input .cell-content, body[data-theme="green"] .user-input .cell-content, body[data-theme="black"] .user-input .cell-content, body[data-theme="pink"] .user-input .cell-content, body[data-theme="turquoise"] .user-input .cell-content { color: var(--primary-color); }
    body[data-theme="light"] .user-input .cell-content { color: #1e40af; }

    /* --- Общие стили --- */
    body { background-color: var(--body-bg); color: var(--text-accent); transition: background-color 0.3s; }
    #game-container { transition: transform 0.2s ease-in-out; background-color: var(--container-bg); width: 100%; max-width: 420px; margin: auto; }
    @media (min-width: 768px) { #game-container { max-width: 600px; } }
    @media (min-width: 1024px) { #game-container { max-width: 640px; } }
    .glow { box-shadow: 0 0 10px color-mix(in srgb, var(--primary-color) 50%, transparent); }
    .title-text { color: var(--primary-color); }
    .control-button, .select-box { background-color: var(--cell-bg); color: var(--text-accent); }
    .main-button { background-color: var(--primary-color); color: white; }
    .main-button:hover { background-color: var(--primary-hover); }
    .grid-container { display: grid; grid-template-columns: repeat(9, minmax(0, 1fr)); gap: 2px; position: relative; width: 100%; padding: 3px; border-radius: 12px; background-color: var(--grid-line); }
    .cell { transition: background-color 0.2s ease-in-out; width: 100%; height: 0; padding-bottom: 100%; position: relative; border: none; border-radius: 6px; font-size: clamp(1rem, 4.5vw, 1.75rem); caret-color: transparent; background-color: var(--cell-bg); }
    .cell-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    .error .cell-content { color: var(--error-text) !important; font-weight: 700; }
    .given .cell-content { color: var(--given-text); font-weight: 700; }
    .user-input .cell-content { font-weight: 500; }
    .grid-separator { position: absolute; z-index: 1; background-color: var(--primary-color); }
    .v-sep-1 { left: 33.333%; right: 33.333%; top: 3px; bottom: 3px; width: 2px; transform: translateX(-1px); }
    .v-sep-2 { left: 66.666%; right: 0; top: 3px; bottom: 3px; width: 2px; transform: translateX(-1px); }
    .h-sep-1 { top: 33.333%; bottom: 33.333%; left: 3px; right: 3px; height: 2px; transform: translateY(-1px); }
    .h-sep-2 { top: 66.666%; bottom: 0; left: 3px; right: 3px; height: 2px; transform: translateY(-1px); }
    .number-button { width: 100%; height: 0; padding-bottom: 100%; position: relative; }
    .number-button-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: clamp(1rem, 4vw, 1.5rem); border-radius: 0.375rem; background-color: var(--cell-bg); color: var(--text-accent); transition: background-color 0.2s; }
    .number-button-wrapper.selected .number-button-content { background-color: var(--primary-color); color: var(--given-text); }
    .number-button-wrapper.disabled .number-button-content { opacity: 0.4; cursor: not-allowed; }
    .area-highlight { background-color: var(--area-highlight-bg); }
    .active-cell { background-color: var(--active-cell-bg) !important; }
    .highlight { background-color: var(--highlight-bg) !important; z-index: 5; }
    .highlight .cell-content { color: var(--highlight-text) !important; font-weight: 700; }
    .hinted { background-color: var(--hint-bg) !important; z-index: 10; }
    .hinted .cell-content { color: var(--hint-text) !important; font-weight: 700; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
    .modal-content { background-color: var(--container-bg); padding: 1.5rem; border-radius: 1rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal-preview-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 1px; width: 80px; height: 80px; background-color: var(--grid-line); flex-shrink: 0; }
    .modal-preview-cell { background-color: var(--cell-bg); font-size: 0.5rem; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-2 sm:p-4">
  <div id="game-container" class="rounded-2xl p-4 glow">
    <h1 class="title-text text-2xl font-bold text-center mb-4">Судоку</h1>
    <div class="mb-4 flex justify-between items-center">
      <select id="difficulty" class="select-box rounded-lg p-2 glow text-sm">
        <option value="easy">Лёгкий</option> <option value="medium">Средний</option> <option value="hard">Сложный</option>
      </select>
      <div class="flex items-center gap-2 sm:gap-4 relative">
        <button id="recent-games-button" class="control-button p-2 rounded-lg glow transition-colors" title="Недавние игры"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg></button>
        <button id="settings-button" class="control-button p-2 rounded-lg glow transition-colors" title="Настройки темы"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-1.11.55-.102 1.13-.102 1.68 0 .55.103 1.02.568 1.11 1.11.09.542.09 1.128 0 1.67-.09.542-.56 1.007-1.11 1.11-.55-.102-1.13-.102-1.68 0-.55-.103-1.02-.568-1.11-1.11-.09-.542-.09-1.128 0-1.67zM14.25 10.25a2.25 2.25 0 00-2.25-2.25H7.5a2.25 2.25 0 00-2.25 2.25v.5c0 .59.38 1.095.92 1.254a2.25 2.25 0 011.68.026l.22.067.22.067.22.067a2.25 2.25 0 011.13 1.933V16.5a2.25 2.25 0 002.25 2.25h.5a2.25 2.25 0 002.25-2.25v-2.25a2.25 2.25 0 00-1.13-1.933l-.22-.067-.22-.067-.22-.067a2.25 2.25 0 01-1.68-.026 1.125 1.125 0 01-.92-1.254v-.5z" /></svg></button>
        <div id="theme-panel" class="hidden absolute top-full right-0 mt-2 p-2 bg-gray-800 rounded-lg shadow-lg z-20"><div class="flex gap-2 flex-wrap max-w-xs justify-end"><button class="theme-button w-6 h-6 rounded-full bg-purple-500 border-2" data-theme="purple"></button><button class="theme-button w-6 h-6 rounded-full bg-orange-500 border-2" data-theme="orange"></button><button class="theme-button w-6 h-6 rounded-full bg-green-500 border-2" data-theme="green"></button><button class="theme-button w-6 h-6 rounded-full bg-gray-500 border-2" data-theme="black"></button><button class="theme-button w-6 h-6 rounded-full bg-pink-500 border-2" data-theme="pink"></button><button class="theme-button w-6 h-6 rounded-full bg-teal-500 border-2" data-theme="turquoise"></button><button class="theme-button w-6 h-6 rounded-full bg-yellow-700 border-2" data-theme="light"></button></div></div>
        <div id="timer" class="timer-text font-semibold text-sm">00:00</div>
      </div>
    </div>
    <div id="grid" class="grid-container mx-auto"><div class="grid-separator v-sep-1"></div><div class="grid-separator v-sep-2"></div><div class="grid-separator h-sep-1"></div><div class="grid-separator h-sep-2"></div></div>
    <div id="number-row" class="grid grid-cols-10 gap-1 sm:gap-2 mt-4 mx-auto"></div>
    <div class="mt-4 flex flex-wrap justify-center gap-2">
      <button id="undo-button" class="main-button text-white px-3 py-2 rounded-lg glow text-sm disabled:opacity-50" disabled title="Отменить"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mx-auto"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /></svg></button>
      <button id="hint-button" class="main-button text-white px-3 py-2 rounded-lg glow text-sm disabled:opacity-50" disabled title="Подсказка">
        <!-- ИСПРАВЛЕННАЯ ИКОНКА ЛАМПОЧКИ -->
        <svg fill="currentColor" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mx-auto">
          <path d="M2.016 16q0 0.832 0.576 1.44t1.408 0.576 1.408-0.576 0.608-1.44-0.608-1.408-1.408-0.576-1.408 0.576-0.576 1.408zM5.504 24.512q0 0.8 0.576 1.408t1.44 0.576 1.408-0.576 0.576-1.408-0.576-1.408-1.408-0.608-1.44 0.608-0.576 1.408zM5.504 7.52q0 0.832 0.576 1.408t1.44 0.576 1.408-0.576 0.576-1.408-0.576-1.408-1.408-0.608-1.44 0.608-0.576 1.408zM8 16q0 3.328 2.336 5.664t5.664 2.336 5.664-2.336 2.336-5.664-2.336-5.632-5.664-2.368-5.664 2.368-2.336 5.632zM12 16q0-1.632 1.184-2.816t2.816-1.184 2.816 1.184 1.184 2.816-1.184 2.848-2.816 1.152-2.816-1.152-1.184-2.848zM14.016 28q0 0.832 0.576 1.44t1.408 0.576 1.408-0.576 0.608-1.44-0.608-1.408-1.408-0.576-1.408 0.576-0.576 1.408zM14.016 4q0 0.832 0.576 1.44t1.408 0.576 1.408-0.576 0.608-1.44-0.608-1.408-1.408-0.576-1.408 0.576-0.576 1.408zM22.496 24.512q0 0.8 0.576 1.408t1.408 0.576 1.44-0.576 0.576-1.408-0.576-1.408-1.44-0.608-1.408 0.608-0.576 1.408zM22.496 7.52q0 0.832 0.576 1.408t1.408 0.576 1.44-0.576 0.576-1.408-0.576-1.408-1.44-0.608-1.408 0.608-0.576 1.408zM26.016 16q0 0.832 0.576 1.44t1.408 0.576 1.408-0.576 0.608-1.44-0.608-1.408-1.408-0.576-1.408 0.576-0.576 1.408z"></path>
        </svg>
      </button>
      <button id="newGame" class="main-button text-white px-3 py-2 rounded-lg glow text-sm">Новая игра</button>
      <button id="highlightToggle" class="main-button text-white px-3 py-2 rounded-lg glow text-sm">Подсветка</button>
      <button id="check" class="main-button text-white px-3 py-2 rounded-lg glow text-sm">Проверить</button>
    </div>
    <p id="message" class="mt-4 text-center text-sm h-5"></p>
  </div>

  <div id="recent-games-modal" class="modal-overlay hidden"> <div class="modal-content"> <div class="flex justify-between items-center mb-4"> <h2 class="text-xl font-bold title-text">Недавние игры</h2> <button id="close-modal-button" class="text-2xl">&times;</button> </div> <div id="recent-games-list" class="space-y-2"></div> </div> </div>

  <script>
    const elements = { body: document.body, gameContainer: document.getElementById('game-container'), grid: document.getElementById('grid'), difficulty: document.getElementById('difficulty'), newGameBtn: document.getElementById('newGame'), checkBtn: document.getElementById('check'), highlightBtn: document.getElementById('highlightToggle'), timer: document.getElementById('timer'), message: document.getElementById('message'), numberRow: document.getElementById('number-row'), undoBtn: document.getElementById('undo-button'), hintBtn: document.getElementById('hint-button'), recentGamesBtn: document.getElementById('recent-games-button'), recentGamesModal: document.getElementById('recent-games-modal'), closeModalBtn: document.getElementById('close-modal-button'), recentGamesList: document.getElementById('recent-games-list'), settingsBtn: document.getElementById('settings-button'), themePanel: document.getElementById('theme-panel')};
    let grid = [], solution = [], givenCells = new Set(), timerInterval, startTime=0, activeCell = null, activeTool = null, highlightEnabled = true, undoStack = [];
    
    function createGrid() { /* ... */ elements.grid.innerHTML='<div class="grid-separator v-sep-1"></div><div class="grid-separator v-sep-2"></div><div class="grid-separator h-sep-1"></div><div class="grid-separator h-sep-2"></div>';grid=Array(9).fill().map(()=>Array(9).fill(0));givenCells.clear();for(let i=0;i<9;i++)for(let j=0;j<9;j++){const e=document.createElement("div");e.className="cell";const t=document.createElement("div");t.className="cell-content";e.appendChild(t),e.addEventListener("click",(t)=>{t.stopPropagation();handleCellClick(i,j)}),elements.grid.appendChild(e)}}
    function createNumberRow() { /* ... */ elements.numberRow.innerHTML="";for(let i=1;i<=9;i++){const e=document.createElement("div");e.className="number-button-wrapper",e.dataset.tool=i,e.innerHTML=`<div class="number-button"><div class="number-button-content"><span>${i}</span></div></div>`,e.addEventListener("click",()=>{e.classList.contains("disabled")||selectTool(i)}),elements.numberRow.appendChild(e)}const e=document.createElement("div");e.className="number-button-wrapper",e.dataset.tool="erase",e.innerHTML=`<div class="number-button"><div class="number-button-content"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg></div></div>`,e.addEventListener("click",()=>selectTool("erase")),elements.numberRow.appendChild(e)}
    function generatePuzzle(difficulty) { /* ... */ solution=Array(9).fill().map(()=>Array(9).fill(0)),fillDiagonal(),fillRemaining(0,0),grid=solution.map(e=>e.slice());const e=[];for(let t=0;t<9;t++)for(let n=0;n<9;n++)e.push([t,n]);shuffle(e);const t={easy:45,medium:52,hard:58}[difficulty];for(let n=0;n<t;n++){const[l,s]=e[n];grid[l][s]=0}givenCells.clear();for(let n=0;n<9;n++)for(let l=0;l<9;l++)0!==grid[n][l]&&givenCells.add(`${n},${l}`);renderGrid();function fillDiagonal(){for(let e=0;e<9;e+=3){const t=[1,2,3,4,5,6,7,8,9];shuffle(t);let n=0;for(let l=0;l<3;l++)for(let s=0;s<3;s++)solution[e+l][e+s]=t[n++]}}function isSafe(e,t,n){for(let l=0;l<9;l++)if(solution[e][l]===n||solution[l][t]===n)return!1;const l=e-e%3,s=t-t%3;for(let e=0;e<3;e++)for(let t=0;t<3;t++)if(solution[l+e][s+t]===n)return!1;return!0}function fillRemaining(e,t){if(t>=9&&(e++,t=0),e>=9)return!0;if(0!==solution[e][t])return fillRemaining(e,t+1);const n=[1,2,3,4,5,6,7,8,9];shuffle(n);for(let l of n)if(isSafe(e,t,l)){if(solution[e][t]=l,fillRemaining(e,t+1))return!0;solution[e][t]=0}return!1}function shuffle(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}}
    function handleCellClick(row, col) { (activeTool!==null)?(grid[row][col]===0||(grid[row][col]!==0&&activeTool==='erase'))?performAction(activeTool,row,col):(selectTool(null),selectCell(row,col)):selectCell(row,col)}
    function selectCell(row, col) { clearHighlights();activeCell=[row,col];const e=document.querySelectorAll(".cell");e.forEach((t,n)=>{const l=Math.floor(n/9),s=n%9,c=l===row,r=s===col,o=Math.floor(l/3)===Math.floor(row/3)&&Math.floor(s/3)===Math.floor(col/3);(c||r||o)&&t.classList.add("area-highlight")}),e[9*row+col].classList.add("active-cell"),highlightEnabled&&0!==grid[row][col]&&highlightSimilarNumbers(grid[row][col])}
    function performAction(action, row, col) { if(givenCells.has(`${row},${col}`)) return; const value = (action === 'erase') ? 0 : action; const prevValue = grid[row][col]; if(prevValue === value) return; undoStack.push({row, col, prevValue, value}); updateUndoButtonState(); const cellElement = document.querySelectorAll(".cell")[row * 9 + col]; grid[row][col] = value; cellElement.querySelector(".cell-content").textContent = value || ''; cellElement.classList.remove('error'); cellElement.classList.toggle('user-input', value !== 0); updateNumberPanelState(); if(highlightEnabled) { clearHighlights(true); if (value !== 0) highlightSimilarNumbers(value); }}
    function undoLastAction() { if (undoStack.length === 0) return; const lastMove = undoStack.pop(); const {row, col, prevValue} = lastMove; const cellElement = document.querySelectorAll(".cell")[row * 9 + col]; grid[row][col] = prevValue; cellElement.querySelector(".cell-content").textContent = prevValue || ''; cellElement.classList.remove('error'); cellElement.classList.toggle('user-input', prevValue !== 0); updateUndoButtonState(); updateNumberPanelState(); if(activeCell && activeCell[0] === row && activeCell[1] === col) { selectCell(row, col); } }
    function selectTool(tool) { activeTool = (activeTool === tool) ? null : tool; updateToolSelection(); clearHighlights(); activeCell = null; if (activeTool && activeTool !== 'erase' && highlightEnabled) { highlightSimilarNumbers(activeTool); } }
    function deselectCell() { activeCell && (clearHighlights(), activeCell = null); if (activeTool !== null) { activeTool = null; updateToolSelection(); } }
    function renderGrid(shouldResetTimer = true) { document.querySelectorAll(".cell").forEach((e,t)=>{const n=Math.floor(t/9),l=t%9;e.querySelector(".cell-content").textContent=grid[n][l]||"",e.className="cell",givenCells.has(`${n},${l}`)?e.classList.add("given"):0!==grid[n][l]&&e.classList.add("user-input")});activeCell=null;activeTool=null;updateToolSelection();clearHighlights();if(shouldResetTimer)resetTimer();updateNumberPanelState();undoStack = []; updateUndoButtonState(); updateHintButtonState();}
    function updateNumberPanelState() { const counts = Array(10).fill(0); for (let row of grid) for (let cell of row) if (cell !== 0) counts[cell]++; elements.numberRow.querySelectorAll(".number-button-wrapper").forEach((wrapper, index) => { if (index < 9) { const num = index + 1; const isExhausted = counts[num] === 9; wrapper.classList.toggle("disabled", isExhausted); if (isExhausted && activeTool === num) { selectTool(null); } } });}
    function updateToolSelection() { document.querySelectorAll('.number-button-wrapper').forEach(btn => btn.classList.toggle('selected', btn.dataset.tool == activeTool)); }
    function updateUndoButtonState() { elements.undoBtn.disabled = undoStack.length === 0; }
    function updateHintButtonState() { const isFull = grid.every(row => row.every(cell => cell !== 0)); elements.hintBtn.disabled = isFull; }
    function getHint() { clearHintedCells(); const mistakes = []; const emptyCells = []; for (let r = 0; r < 9; r++) for (let c = 0; c < 9; c++) if (!givenCells.has(`${r},${c}`)) { if (grid[r][c] !== 0 && grid[r][c] !== solution[r][c]) mistakes.push([r, c]); else if (grid[r][c] === 0) emptyCells.push([r, c]); } let targetCell; if (mistakes.length > 0) targetCell = mistakes[Math.floor(Math.random() * mistakes.length)]; else if (emptyCells.length > 0) targetCell = emptyCells[Math.floor(Math.random() * emptyCells.length)]; else return; const [row, col] = targetCell; const correctValue = solution[row][col]; performAction(correctValue, row, col); const cellElement = document.querySelectorAll('.cell')[row * 9 + col]; cellElement.classList.add('hinted'); }
    function checkSolution() { if(!grid.every(e=>e.every(e=>e)))return void(elements.message.textContent="Заполните все ячейки.");let e=!0;document.querySelectorAll(".cell").forEach((t,n)=>{const l=Math.floor(n/9),s=n%9;givenCells.has(`${l},${s}`)||t.classList.toggle("error",grid[l][s]!==solution[l][s])&&(e=!1)}),e?(clearInterval(timerInterval),elements.message.textContent="Поздравляем! Вы решили пазл!",elements.numberRow.querySelectorAll(".number-button-wrapper").forEach(e=>e.classList.add("disabled")), elements.hintBtn.disabled = true):elements.message.textContent="В решении есть ошибки."}
    function highlightSimilarNumbers(e){ if(!e) return; document.querySelectorAll(".cell").forEach((t,n)=>{if(grid[Math.floor(n/9)][n%9]===e)t.classList.add("highlight")})}
    function clearHighlights(keepArea = false){ clearHintedCells(); document.querySelectorAll(".cell").forEach(e=>{e.classList.remove("highlight"),keepArea||e.classList.remove("area-highlight","active-cell")})}
    function clearHintedCells() { document.querySelectorAll('.hinted').forEach(c => c.classList.remove('hinted')); }
    function resetTimer(elapsedSeconds = 0){ clearInterval(timerInterval); startTime = Date.now() - elapsedSeconds * 1000; timerInterval = setInterval(() => { const elapsed = Math.floor((Date.now() - startTime) / 1000); const minutes = String(Math.floor(elapsed / 60)).padStart(2, '0'); const seconds = String(elapsed % 60).padStart(2, '0'); elements.timer.textContent = `${minutes}:${seconds}`; }, 1000); }
    function applyTheme(e){document.body.dataset.theme=e,localStorage.setItem("sudoku-theme",e),document.querySelectorAll(".theme-button").forEach(t=>{t.style.borderColor=t.dataset.theme===e?"var(--primary-color)":"transparent"})}
    function saveCurrentGame() { if (grid.length === 0 || grid.every(r=>r.every(c=>c===0))) return; const gameState = { grid: grid, solution: solution, givenCells: Array.from(givenCells), time: Math.floor((Date.now() - startTime) / 1000), difficulty: elements.difficulty.value, savedAt: new Date().toISOString() }; let recentGames = JSON.parse(localStorage.getItem('sudoku-recent-games')) || []; recentGames.unshift(gameState); recentGames = recentGames.slice(0, 5); localStorage.setItem('sudoku-recent-games', JSON.stringify(recentGames)); }
    function loadGame(gameState) { grid = gameState.grid; solution = gameState.solution; givenCells = new Set(gameState.givenCells); elements.difficulty.value = gameState.difficulty; renderGrid(false); resetTimer(gameState.time); elements.recentGamesModal.classList.add('hidden'); }
    function populateRecentGames() { const games = JSON.parse(localStorage.getItem('sudoku-recent-games')) || []; elements.recentGamesList.innerHTML = ''; if (games.length === 0) { elements.recentGamesList.innerHTML = '<p>Сохранённых игр нет.</p>'; return; } games.forEach(game => { const gameEl = document.createElement('div'); gameEl.className = 'flex items-center gap-4 p-2 rounded-lg border-b border-[var(--grid-line)]'; const time = new Date(game.savedAt); const previewGrid = game.grid.flat().map((cell, i) => `<div class="modal-preview-cell" style="color: ${game.givenCells.includes(`${Math.floor(i/9)},${i%9}`) ? 'var(--given-text)' : 'var(--primary-color)'}; font-weight: ${game.givenCells.includes(`${Math.floor(i/9)},${i%9}`) ? 700 : 500}">${cell || ''}</div>`).join(''); gameEl.innerHTML = ` <div class="modal-preview-grid">${previewGrid}</div> <div class="flex-grow"> <p class="font-bold">${time.toLocaleDateString()} ${time.toLocaleTimeString()}</p> <p class="text-sm opacity-70">${game.difficulty}</p> </div> <div class="flex flex-col gap-1"> <button class="load-game-button main-button text-white px-3 py-1 rounded-lg glow text-xs" data-id="${game.savedAt}">Загрузить</button> <button class="delete-game-button control-button text-red-500 hover:bg-red-500 hover:text-white px-3 py-1 rounded-lg glow text-xs" data-id="${game.savedAt}">Удалить</button> </div> `; elements.recentGamesList.appendChild(gameEl); }); }
    function deleteGame(gameId) { if (!confirm('Вы уверены, что хотите удалить эту игру?')) return; let recentGames = JSON.parse(localStorage.getItem('sudoku-recent-games')) || []; recentGames = recentGames.filter(game => game.savedAt !== gameId); localStorage.setItem('sudoku-recent-games', JSON.stringify(recentGames)); populateRecentGames(); }

    function init() {
        const startNewGame = () => { saveCurrentGame(); createGrid(); createNumberRow(); generatePuzzle(elements.difficulty.value); elements.message.textContent = ""; };
        elements.newGameBtn.addEventListener('click', startNewGame);
        elements.checkBtn.addEventListener('click', checkSolution);
        elements.difficulty.addEventListener('change', startNewGame);
        elements.undoBtn.addEventListener('click', undoLastAction);
        elements.hintBtn.addEventListener('click', getHint);
        elements.highlightBtn.addEventListener('click', ()=>{highlightEnabled=!highlightEnabled,elements.highlightBtn.textContent=`Подсветка: ${highlightEnabled?"ВКЛ":"ВЫКЛ"}`;if(!highlightEnabled){clearHighlights()}else{if(activeTool && activeTool !== 'erase'){highlightSimilarNumbers(activeTool)}else if(activeCell&&grid[activeCell[0]][activeCell[1]]){highlightSimilarNumbers(grid[activeCell[0]][activeCell[1]])}}});
        elements.settingsBtn.addEventListener('click', e => { e.stopPropagation(); elements.themePanel.classList.toggle('hidden'); });
        elements.recentGamesBtn.addEventListener('click', () => { populateRecentGames(); elements.recentGamesModal.classList.remove('hidden'); });
        elements.closeModalBtn.addEventListener('click', () => elements.recentGamesModal.classList.add('hidden'));
        elements.themePanel.addEventListener('click', e => { e.stopPropagation(); if (e.target.closest('.theme-button')) { applyTheme(e.target.closest('.theme-button').dataset.theme); } });
        elements.recentGamesList.addEventListener('click', e => { const loadBtn = e.target.closest('.load-game-button'); const deleteBtn = e.target.closest('.delete-game-button'); if (loadBtn) { const gameId = loadBtn.dataset.id; const games = JSON.parse(localStorage.getItem('sudoku-recent-games')); const gameToLoad = games.find(g => g.savedAt === gameId); if (gameToLoad) loadGame(gameToLoad); } if (deleteBtn) { const gameId = deleteBtn.dataset.id; deleteGame(gameId); } });
        document.addEventListener('click', (e) => { if (!elements.gameContainer.contains(e.target) && !elements.recentGamesModal.contains(e.target)) deselectCell(); elements.themePanel.classList.add('hidden'); });
        window.addEventListener('beforeunload', saveCurrentGame);
        
        applyTheme(localStorage.getItem('sudoku-theme') || 'purple');
        startNewGame();
    }
    init();
  </script>
</body>
</html>
